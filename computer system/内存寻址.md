### 内存地址

程序员使用 **内存地址(memory address)** 访问内存单元，我们必须区分三种单元：

* 逻辑地址(logical address)：每一个逻辑地址都由一个段(segmenr)和偏移量(offset或displacement)组成，偏移量指明了从段开始的地方到实际地址之间的距离。
* 线性地址(linear address)(也称虚拟地址viritual address)：是一个32位无符号整数，线性地址通常用十六进制数字表示，值的范围从0x00000000到0xffffffff。
* 物理地址(physical address)用于内存芯片级内存单元寻址。它们与从微处理器的地址引脚发送到内存总线上的电信号相对应。物理地址由32位或36位无符号整数表示。

![[转换图.png]]

在x86保护模式下，段的信息（段基线性地址、长度、权限等）即**段描述符**占8个字节，段信息无法直接存放在段寄存器中（段寄存器只有2字节）。Intel的设计是段描述符集中存放在GDT或LDT中，而**段寄存器存放的是段描述符在GDT或LDT内的索引值**(index)。

**Linux中逻辑地址等于线性地址**。Linux所有的段（用户代码段、用户数据段、内核代码段、内核数据段）的线性地址都是从 0x00000000 开始，长度4G，这样 线性地址=逻辑地址+ 0x00000000，也就是说逻辑地址等于线性地址了。

这样的情况下**Linux只用到了GDT**，不论是用户任务还是内核任务，都没有用到LDT。GDT的第12和13项段描述符是 __KERNEL_CS 和__KERNEL_DS，第14和15项段描述符是 __USER_CS 和__USER_DS。内核任务使用__KERNEL_CS 和__KERNEL_DS，所有的用户任务共用__USER_CS 和__USER_DS，也就是说不需要给每个任务再单独分配段描述符。内核段描述符和用户段描述符虽然起始线性地址和长度都一样，但DPL(描述符特权级)是不一样的。__KERNEL_CS 和__KERNEL_DS 的DPL值为0（最高特权），__USER_CS 和__USER_DS的DPL值为3。


在多处理器系统中，所有CPU都共享同一内存，这意味着RAM芯片可以由独立的CPU并发地访问。因为在RAM芯片上的读或写操作必须串行地执行，因此一种所谓 **内存仲裁器(memoryarbiler)** 的硬件电路插在总线和每个RAM芯片之间。其作用是如果某个RAM芯片空闲，就准予一个CPU访问，如果该芯片忙于为另一个处理器提出的请求服务，就延迟这个CPU的访问。即使在单处理器上也使用内存仲裁器，因为单处理器系统中包含一个叫做DMA控制器的特殊处理器，而DMA控制器与CPU并发操作。从编程观点看，因为仲裁器由硬件电路管理，因此它是隐藏的。


## 分段

Intel微处理器以两种不同的方式执行地址转换，这两种方式分别称为 **实模式(real mode)** 和 **保护模式(protected mode)** 。

### 实模式

在 [Real Mode](https://wiki.osdev.org/Real_Mode "Real Mode") 中，使用 A：B 形式的逻辑地址来寻址内存。使用等式将其转换为物理地址：

```
Physical address = (A * 0x10) + B
```

纯实模式下的 (寄存器)registers 限制为 16 位以进行寻址。16 位可以表示 0 到 64k 之间的任何整数。这意味着，如果我们将 A 设置为固定值并允许 B 更改，我们可以寻址 64k 的内存区域。这个 64k 区域称为段。很明显，区段可以重叠。

```
A = A 64k segment B = Offset within the segment
```

x86 系列计算机有 6 个段寄存器（CS、DS、ES、FS、GS、SS）。它们彼此完全独立。

| CS  |                  Code Segment   代码段                   |
| --- | :---------------------------------------------------: |
| DS  |                     Data Segment                      |
| SS  | [Stack](https://wiki.osdev.org/Stack "Stack") Segment |
| ES  |                     Extra Segment                     |
| FS  |               General Purpose Segments                |
| GS  |               General Purpose Segments                |

